<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>å…³æ³¨åˆ—è¡¨ - Easy Blog</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
    <style>
        .following-container {
            margin-top: 20px;
        }
        
        .user-card {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 20px;
            object-fit: cover;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-size: 18px;
            font-weight: bold;
            color: #056de8;
            margin-bottom: 5px;
        }
        
        .user-stats {
            display: flex;
            color: #666;
            font-size: 14px;
            gap: 15px;
        }
        
        .unfollow-btn {
            background: #f0f4ff;
            color: #056de8;
            border: 1px solid #e0e9ff;
            border-radius: 20px;
            padding: 8px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .unfollow-btn:hover {
            background: #e0e9ff;
        }
        
        .no-following {
            text-align: center;
            padding: 40px 0;
            color: #999;
            font-size: 16px;
        }
        
        .loading {
            text-align: center;
            padding: 40px 0;
            color: #666;
        }

        /* Tab styles */
        .tab-container {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e0e9ff;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            color: #666;
            font-size: 16px;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .tab.active {
            color: #056de8;
            border-color: #056de8;
            font-weight: bold;
        }
        
        /* Content sections */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>

<body>
    <header class="navbar">
        <!-- ä¸Šå±‚ -->
        <div class="header-top">
            <div class="logo">Easy Blog</div>
            <input class="search" type="text" id="searchInput" placeholder="Search">
            <div class="user" id="userArea">
                <!-- ç”¨æˆ·åŒºåŸŸç”±JSåŠ¨æ€å¡«å…… -->
            </div>
        </div>
        <!-- ä¸‹å±‚ -->
        <div class="header-bottom">
            <a href="/">Home</a>
            <a href="/hot">Hot</a>
            <a href="/follow" class="active">Following</a>
        </div>
    </header>

    <div class="main-grid">
        <main class="center">
            <h2 style="margin-bottom: 20px; color: #056de8;">Following</h2>
            
            <!-- æ·»åŠ æ ‡ç­¾é¡µåˆ‡æ¢ -->
            <div class="tab-container">
                <div class="tab active" data-tab="posts">Posts</div>
                <div class="tab" data-tab="users">Users</div>
            </div>
            
            <!-- å…³æ³¨ç”¨æˆ·çš„å¸–å­ -->
            <div class="tab-content active" id="posts-content">
                <div class="feed" id="followingPosts">
                    <div class="loading">Loading posts from people you follow...</div>
                </div>
            </div>
            
            <!-- å…³æ³¨çš„ç”¨æˆ·åˆ—è¡¨ -->
            <div class="tab-content" id="users-content">
                <div class="following-container" id="followingList">
                    <div class="loading">Loading users you follow...</div>
                </div>
            </div>
        </main>

        <aside class="right">
            <div class="user-profile" id="userProfile">
                <img src="/static/avatar.png" alt="ç”¨æˆ·å¤´åƒ" class="avatar" id="avatar">
                <div class="user-info">
                    <div class="username" id="username">æœªç™»å½•</div>
                    <div class="stats">
                        <span>Blog <b id="postCount">0</b></span>
                        <span>Following <b id="followCount">0</b></span>
                    </div>
                </div>
                <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ input -->
                <input type="file" id="avatarInput" accept="image/*" style="display:none;">
                <!-- æ›´æ”¹å¤´åƒæŒ‰é’® -->
                <button class="write-btn" id="changeAvatarBtn">æ›´æ”¹å¤´åƒ</button>
            </div>
        </aside>
    </div>

    <footer class="footer">
        &copy; Hackathon 2025 Easy Blog
    </footer>

    <script src="{{ url_for('static', filename='main.js') }}"></script>
    <script>
        // æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾å’Œå†…å®¹
                    this.classList.add('active');
                    const tabName = this.getAttribute('data-tab');
                    document.getElementById(`${tabName}-content`).classList.add('active');
                });
            });
        }

        // è·å–å…³æ³¨çš„ç”¨æˆ·åˆ—è¡¨
        function loadFollowingList() {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                document.getElementById('followingList').innerHTML = `
                    <div class="no-following">
                        <p>è¯·å…ˆç™»å½•æŸ¥çœ‹å…³æ³¨åˆ—è¡¨</p>
                        <button onclick="window.location.href='/login'" style="margin-top: 10px; padding: 10px 20px; background: #056de8; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            å»ç™»å½•
                        </button>
                    </div>
                `;
                return;
            }

            fetch(`/api/following?user_id=${userId}`)
                .then(response => response.json())
                .then(data => {
                    const followingListDiv = document.getElementById('followingList');
                    if (data.status === 0) {
                        const followings = data.followings || [];
                        
                        if (followings.length === 0) {
                            followingListDiv.innerHTML = `
                                <div class="no-following">
                                    <p>æ‚¨è¿˜æ²¡æœ‰å…³æ³¨ä»»ä½•äºº</p>
                                </div>
                            `;
                            return;
                        }
                        
                        followingListDiv.innerHTML = '';
                        followings.forEach(user => {
                            const userCard = document.createElement('div');
                            userCard.className = 'user-card';
                            userCard.innerHTML = `
                                <img src="${user.avatar || '/static/avatar.png'}" alt="${user.username}" class="user-avatar">
                                <div class="user-info">
                                    <div class="user-name">${user.username}</div>
                                    <div class="user-stats">
                                        <span>åšå®¢: ${user.post_count || 0}</span>
                                    </div>
                                </div>
                                <button class="unfollow-btn" data-user-id="${user.id}">unfollow</button>
                            `;
                            followingListDiv.appendChild(userCard);
                            
                            // æ·»åŠ ç”¨æˆ·å¡ç‰‡ç‚¹å‡»äº‹ä»¶ - ç‚¹å‡»å¤´åƒæˆ–ç”¨æˆ·åè·³è½¬åˆ°ç”¨æˆ·é¡µé¢
                            const userAvatar = userCard.querySelector('.user-avatar');
                            const userName = userCard.querySelector('.user-name');
                            
                            function goToUserPage() {
                                // å‡è®¾æœ‰ç”¨æˆ·é¡µé¢è·¯ç”±
                                window.location.href = `/user/${user.id}`;
                            }
                            
                            userAvatar.addEventListener('click', goToUserPage);
                            userName.addEventListener('click', goToUserPage);
                            
                            // æ·»åŠ å–æ¶ˆå…³æ³¨äº‹ä»¶
                            const unfollowBtn = userCard.querySelector('.unfollow-btn');
                            unfollowBtn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const followeeId = this.getAttribute('data-user-id');
                                unfollowUser(userId, followeeId, userCard);
                            });
                        });
                    } else {
                        followingListDiv.innerHTML = `
                            <div class="no-following">
                                <p>åŠ è½½å…³æ³¨åˆ—è¡¨å¤±è´¥: ${data.msg || 'æœªçŸ¥é”™è¯¯'}</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½å…³æ³¨åˆ—è¡¨é”™è¯¯:', error);
                    document.getElementById('followingList').innerHTML = `
                        <div class="no-following">
                            <p>ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</p>
                        </div>
                    `;
                });
        }
        
        // æ–°å¢ï¼šåŠ è½½å…³æ³¨ç”¨æˆ·çš„å¸–å­
        function loadFollowingPosts() {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                document.getElementById('followingPosts').innerHTML = `
                    <div class="no-following">
                        <p>è¯·å…ˆç™»å½•æŸ¥çœ‹å…³æ³¨çš„å¸–å­</p>
                        <button onclick="window.location.href='/login'" style="margin-top: 10px; padding: 10px 20px; background: #056de8; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            å»ç™»å½•
                        </button>
                    </div>
                `;
                return;
            }

            fetch(`/api/following/posts?user_id=${userId}`)
                .then(response => response.json())
                .then(data => {
                    const postsContainer = document.getElementById('followingPosts');
                    
                    if (data.status === 0) {
                        const posts = data.posts || [];
                        
                        if (posts.length === 0) {
                            postsContainer.innerHTML = `
                                <div class="question-card">
                                    <h3>æš‚æ— å†…å®¹</h3>
                                    <p>æ‚¨å…³æ³¨çš„ç”¨æˆ·è¿˜æ²¡æœ‰å‘å¸ƒä»»ä½•å¸–å­ï¼Œæˆ–è€…æ‚¨è¿˜æ²¡æœ‰å…³æ³¨ä»»ä½•äººã€‚</p>
                                </div>
                            `;
                            return;
                        }
                        
                        postsContainer.innerHTML = '';
                        
                        // æ¸²æŸ“å¸–å­åˆ—è¡¨
                        posts.forEach(post => {
                            const date = new Date(post.create_time);
                            const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                            
                            // åˆ›å»ºå¸–å­å¡ç‰‡
                            const postCard = document.createElement('div');
                            postCard.className = 'question-card';
                            
                            // è·å–ç”¨æˆ·ä¿¡æ¯
                            fetch(`/api/user?user_id=${post.user_id}`)
                                .then(res => res.json())
                                .then(userData => {
                                    const username = userData.status === 0 ? userData.user.username : `ç”¨æˆ·ID: ${post.user_id}`;
                                    
                                    postCard.innerHTML = `
                                        <h3>${post.title}</h3>
                                        <p>${post.content.length > 100 ? post.content.substring(0, 100) + '...' : post.content}</p>
                                        <div style="margin-top: 10px; font-size: 14px; color: #888; display: flex; align-items: center; justify-content: space-between;">
                                          <div>
                                            <span>${username}</span> | 
                                            <span>${formattedDate}</span> | 
                                            <span>ğŸ‘ ${post.like_count}</span> | 
                                            <span>ğŸ’¬ ${post.comment_count}</span>
                                          </div>
                                        </div>
                                    `;
                                })
                                .catch(() => {
                                    // ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥æ—¶çš„å¤‡ç”¨æ˜¾ç¤º
                                    postCard.innerHTML = `
                                        <h3>${post.title}</h3>
                                        <p>${post.content.length > 100 ? post.content.substring(0, 100) + '...' : post.content}</p>
                                        <div style="margin-top: 10px; font-size: 14px; color: #888; display: flex; align-items: center; justify-content: space-between;">
                                          <div>
                                            <span>ç”¨æˆ·ID: ${post.user_id}</span> | 
                                            <span>${formattedDate}</span> | 
                                            <span>ğŸ‘ ${post.like_count}</span> | 
                                            <span>ğŸ’¬ ${post.comment_count}</span>
                                          </div>
                                        </div>
                                    `;
                                });
                            
                            // ä¸ºæ•´ä¸ªå¸–å­å¡ç‰‡æ·»åŠ ç‚¹å‡»äº‹ä»¶
                            postCard.style.cursor = 'pointer';
                            postCard.addEventListener('click', function() {
                                window.location.href = `/blog/${post.id}`;
                            });
                            
                            postsContainer.appendChild(postCard);
                        });
                        
                    } else {
                        postsContainer.innerHTML = `
                            <div class="question-card">
                                <h3>åŠ è½½å¤±è´¥</h3>
                                <p>${data.msg || 'æœªçŸ¥é”™è¯¯'}</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½å…³æ³¨ç”¨æˆ·å¸–å­é”™è¯¯:', error);
                    document.getElementById('followingPosts').innerHTML = `
                        <div class="question-card">
                            <h3>åŠ è½½å¤±è´¥</h3>
                            <p>ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</p>
                        </div>
                    `;
                });
        }
        
        // å–æ¶ˆå…³æ³¨ç”¨æˆ·
        function unfollowUser(followerId, followeeId, userCard) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆå…³æ³¨æ­¤ç”¨æˆ·å—ï¼Ÿ')) {
                return;
            }
            
            fetch('/api/unfollow', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    follower_id: parseInt(followerId),
                    followee_id: parseInt(followeeId)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 0) {
                    // æˆåŠŸå–æ¶ˆå…³æ³¨ï¼Œä»DOMä¸­ç§»é™¤ç”¨æˆ·å¡ç‰‡
                    userCard.style.transition = 'all 0.3s';
                    userCard.style.opacity = '0';
                    userCard.style.transform = 'translateX(30px)';
                    
                    setTimeout(() => {
                        userCard.remove();
                        
                        // å¦‚æœæ²¡æœ‰å…³æ³¨çš„äººäº†ï¼Œæ˜¾ç¤ºæç¤º
                        const followingListDiv = document.getElementById('followingList');
                        if (followingListDiv.children.length === 0) {
                            followingListDiv.innerHTML = `
                                <div class="no-following">
                                    <p>æ‚¨è¿˜æ²¡æœ‰å…³æ³¨ä»»ä½•äºº</p>
                                    <button onclick="window.location.href='/'" style="margin-top: 10px; padding: 10px 20px; background: #056de8; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        æµè§ˆç”¨æˆ·
                                    </button>
                                </div>
                            `;
                        }
                        
                        // æ›´æ–°å…³æ³¨è®¡æ•°
                        const followCountElement = document.getElementById('followCount');
                        if (followCountElement) {
                            const currentCount = parseInt(followCountElement.textContent);
                            if (!isNaN(currentCount) && currentCount > 0) {
                                followCountElement.textContent = currentCount - 1;
                            }
                        }
                        
                        // å–æ¶ˆå…³æ³¨åé‡æ–°åŠ è½½å…³æ³¨ç”¨æˆ·çš„å¸–å­
                        loadFollowingPosts();
                    }, 300);
                } else {
                    alert('å–æ¶ˆå…³æ³¨å¤±è´¥: ' + (data.msg || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                console.error('å–æ¶ˆå…³æ³¨è¯·æ±‚é”™è¯¯:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            });
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // ä½¿ç”¨main.jsä¸­çš„å‡½æ•°æ›´æ–°é¡¶éƒ¨ç”¨æˆ·åŒºåŸŸå’Œå³ä¾§ä¸ªäººèµ„æ–™
            if (typeof updateUserArea === 'function') {
                updateUserArea();
            }
            
            if (typeof loadUserProfile === 'function') {
                loadUserProfile();
            }
            
            // è®¾ç½®æ ‡ç­¾é¡µåˆ‡æ¢
            setupTabs();
            
            // åŠ è½½å…³æ³¨åˆ—è¡¨å’Œå…³æ³¨ç”¨æˆ·çš„å¸–å­
            loadFollowingList();
            loadFollowingPosts();
        });
    </script>
</body>

</html>