<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>ç®€æ˜“è®ºå›</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
    <style>
        .user-info {
            margin-left: 15px;
            color: #333;
            font-size: 15px;
        }
        
        .logout-btn {
            margin-left: 10px;
            background: #f0f0f0 !important;
            color: #333 !important;
        }
        
        .logout-btn:hover {
            background: #e0e0e0 !important;
        }
    </style>
</head>

<body>
    <header class="navbar">
        <div class="logo">ç®€æ˜“è®ºå›</div>
        <input class="search" type="text" id="searchInput" placeholder="æœç´¢ä½ æ„Ÿå…´è¶£çš„å†…å®¹">
        <div class="user" id="userArea">
            <!-- ç”¨æˆ·åŒºåŸŸç”±JSåŠ¨æ€å¡«å…… -->
        </div>
    </header>

    <div class="main-grid">
        <aside class="left">
            <ul>
                <li id="homeLink">é¦–é¡µ</li>
                <li id="hotLink">çƒ­é—¨</li>
                <li id="followLink">å…³æ³¨</li>
            </ul>
        </aside>

        <main class="center">
            <div class="feed" id="postList">
                <!-- å¸–å­å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                <div class="question-card">
                    <h3>æ¬¢è¿ä½¿ç”¨ç®€æ˜“è®ºå›</h3>
                    <p>æ­£åœ¨åŠ è½½å¸–å­åˆ—è¡¨...</p>
                </div>
            </div>
        </main>

        <aside class="right">
            <div class="recommend">
                <h4>æ¨èå†…å®¹</h4>
                <ul>
                    <li>ä»Šæ—¥çƒ­é—¨è¯é¢˜</li>
                    <li>æ¯å‘¨ç²¾é€‰</li>
                    <li>è¿‘æœŸæ´»åŠ¨</li>
                </ul>
            </div>
        </aside>
    </div>

    <footer class="footer">
        &copy; 2025 ç®€æ˜“è®ºå›æ¼”ç¤º
    </footer>

    <script>
        // æ›´æ–°é¡¶éƒ¨ç”¨æˆ·åŒºåŸŸæ˜¾ç¤º
        function updateUserArea() {
            const userId = localStorage.getItem('userId');
            const username = localStorage.getItem('username');
            const userArea = document.getElementById('userArea');
            
            if (userId && username) {
                // å·²ç™»å½•çŠ¶æ€
                userArea.innerHTML = `
                    <span class="user-info">æ¬¢è¿ï¼Œ${username}</span>
                    <button id="writeBtn" style="margin-left: 10px; background:#28a745;">å‘å¸–</button>
                    <button id="logoutBtn" class="logout-btn">é€€å‡º</button>
                `;
                
                // æ·»åŠ é€€å‡ºç™»å½•äº‹ä»¶
                document.getElementById('logoutBtn').addEventListener('click', function() {
                    localStorage.removeItem('userId');
                    localStorage.removeItem('username');
                    window.location.reload(); // åˆ·æ–°é¡µé¢
                });
                
                // å‘å¸–æŒ‰é’®äº‹ä»¶
                document.getElementById('writeBtn').addEventListener('click', function() {
                    window.location.href = '/write';
                });
            } else {
                // æœªç™»å½•çŠ¶æ€
                userArea.innerHTML = `
                    <button id="loginBtn">ç™»å½•</button>
                    <button id="registerBtn" style="margin-left: 10px;">æ³¨å†Œ</button>
                `;
                
                // æ·»åŠ ç™»å½•å’Œæ³¨å†ŒæŒ‰é’®äº‹ä»¶
                document.getElementById('loginBtn').addEventListener('click', function() {
                    window.location.href = '/login';
                });
                
                document.getElementById('registerBtn').addEventListener('click', function() {
                    window.location.href = '/register';
                });
            }
        }

        // é¡µé¢å¯¼èˆª
        document.getElementById('homeLink').addEventListener('click', function() {
            window.location.href = '/';
        });

        // åŠ è½½å¸–å­åˆ—è¡¨
        window.onload = function() {
            // æ›´æ–°ç”¨æˆ·åŒºåŸŸæ˜¾ç¤º
            updateUserArea();
            
            // è·å–æœç´¢å‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const searchKey = urlParams.get('key');
            
            // æ„å»ºAPIè¯·æ±‚URL
            let apiUrl = '/api/posts';
            if (searchKey) {
                apiUrl += `?key=${encodeURIComponent(searchKey)}`;
                // å¦‚æœæœ‰æœç´¢å…³é”®è¯ï¼Œæ›´æ–°æœç´¢æ¡†
                document.getElementById('searchInput').value = searchKey;
            }
            
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 0) {
                        const postListDiv = document.getElementById('postList');
                        postListDiv.innerHTML = ''; // æ¸…ç©ºåŠ è½½æç¤º

                        if (data.posts.length === 0) {
                            postListDiv.innerHTML = '<div class="question-card"><h3>æš‚æ— å¸–å­</h3><p>å¿«æ¥å‘å¸ƒç¬¬ä¸€ç¯‡å¸–å­å§ï¼</p></div>';
                            return;
                        }

                        // æ¸²æŸ“å¸–å­åˆ—è¡¨
                        data.posts.forEach(post => {
                            const date = new Date(post.create_time);
                            const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;

                            const postCard = document.createElement('div');
                            postCard.className = 'question-card';
                            postCard.innerHTML = `
                <h3>${post.title}</h3>
                <p>${post.content.length > 100 ? post.content.substring(0, 100) + '...' : post.content}</p>
                <div style="margin-top: 10px; font-size: 14px; color: #888;">
                  <span>ç”¨æˆ·ID: ${post.user_id}</span> | 
                  <span>å‘å¸ƒäº: ${formattedDate}</span> | 
                  <span>ğŸ‘ ${post.like_count}</span> | 
                  <span>ğŸ’¬ ${post.comment_count}</span>
                </div>
              `;

                            // ç‚¹å‡»å¸–å­è·³è½¬åˆ°è¯¦æƒ…é¡µ
                            postCard.style.cursor = 'pointer';
                            postCard.addEventListener('click', function() {
                                window.location.href = `/blog/${post.id}`;
                            });

                            postListDiv.appendChild(postCard);
                        });
                    } else {
                        console.error('åŠ è½½å¸–å­å¤±è´¥:', data.msg);
                    }
                })
                .catch(error => {
                    console.error('ç½‘ç»œé”™è¯¯:', error);
                    document.getElementById('postList').innerHTML =
                        '<div class="question-card"><h3>åŠ è½½å¤±è´¥</h3><p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</p></div>';
                });
        };

        // æœç´¢åŠŸèƒ½
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const searchTerm = this.value.trim();
                if (searchTerm) {
                    window.location.href = `/?key=${encodeURIComponent(searchTerm)}`;
                }
            }
        });
    </script>
</body>

</html>